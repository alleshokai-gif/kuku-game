<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>九九クイズ</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 24px; }
    .wrap { max-width: 900px; margin: 0 auto; }
    .card { border: 2px solid #222; border-radius: 18px; padding: 24px; }
    .q { font-size: 52px; font-weight: 800; margin: 0 0 18px; }
    .sub { font-size: 18px; opacity: .8; margin: 0 0 18px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    button {
      font-size: 34px; padding: 18px 14px; border-radius: 14px;
      border: 2px solid #222; background: #fff;
    }
    button:active { transform: scale(0.99); }
    .row { display: flex; gap: 12px; align-items: center; margin-top: 18px; flex-wrap: wrap; }
    .pill { border: 2px solid #222; border-radius: 999px; padding: 8px 14px; font-size: 18px; }
    .msg { font-size: 22px; font-weight: 700; min-height: 28px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <p class="sub">タップで答えてな（全10問）</p>
      <h1 class="q" id="q">-- × -- = ?</h1>

      <div class="grid" id="choices"></div>

      <div class="row">
        <div class="pill">問題: <span id="n">1</span>/10</div>
        <div class="pill">正解: <span id="ok">0</span></div>
        <div class="pill">まちがい: <span id="ng">0</span></div>
        <div class="msg" id="msg"></div>
      </div>
    </div>
  </div>

<script>
  // ===== DOM =====
  const elQ = document.getElementById("q");
  const elChoices = document.getElementById("choices");
  const elN = document.getElementById("n");
  const elOk = document.getElementById("ok");
  const elNg = document.getElementById("ng");
  const elMsg = document.getElementById("msg");

  // ===== SFX (Web Audio) =====
  let _ac = null;

  function sfxUnlock() {
    if (_ac) return;
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return;
    _ac = new AC();

    // unlock用の超小音（端末によって必要）
    const o = _ac.createOscillator();
    const g = _ac.createGain();
    g.gain.value = 0.0001;
    o.connect(g).connect(_ac.destination);
    o.start();
    o.stop(_ac.currentTime + 0.02);
  }

  function sfxTone(freq = 440, ms = 80, type = "sine", vol = 0.12) {
    if (!_ac) return;
    const t0 = _ac.currentTime;
    const o = _ac.createOscillator();
    const g = _ac.createGain();

    o.type = type;
    o.frequency.setValueAtTime(freq, t0);

    // クリック音防止：アタック→減衰
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.linearRampToValueAtTime(vol, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + ms / 1000);

    o.connect(g).connect(_ac.destination);
    o.start(t0);
    o.stop(t0 + ms / 1000 + 0.02);
  }

  // ピッ（ボタン音）
  function sfxClick() {
    sfxTone(880, 35, "square", 0.06);
  }

  // ポーン（正解）
  function sfxCorrect() {
    sfxTone(784, 70, "sine", 0.10);
    setTimeout(() => sfxTone(1046, 90, "sine", 0.12), 75);
  }

  // ブー（不正解）
  function sfxWrong() {
    sfxTone(160, 140, "sawtooth", 0.14);
    setTimeout(() => sfxTone(120, 160, "sawtooth", 0.14), 90);
  }

  // 最初の操作で音を解禁（自動再生規制対策）
  window.addEventListener("pointerdown", sfxUnlock, { once: true });

  // ===== state =====
  let a = 1, b = 1, ans = 1;
  let cur = 1, ok = 0, ng = 0;
  let locked = false; // 連打防止（900ms待ちの間）

  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function newQuestion() {
    locked = false;
    elMsg.textContent = "";
    a = randInt(1, 9);
    b = randInt(1, 9);
    ans = a * b;

    elQ.textContent = `${a} × ${b} = ?`;
    elN.textContent = cur;

    // 4択を作る（正解 + まちがい3つ）
    const set = new Set([ans]);
    while (set.size < 4) {
      const delta = randInt(-10, 10);
      const v = Math.max(1, ans + delta);
      set.add(v);
    }
    const choices = shuffle([...set]);

    elChoices.innerHTML = "";
    for (const c of choices) {
      const btn = document.createElement("button");
      btn.textContent = c;

      // ✅ メニュ/ボタン音（押した瞬間）
      btn.addEventListener("pointerdown", () => {
        sfxUnlock();
        sfxClick();
      });

      btn.onclick = () => pick(c);
      elChoices.appendChild(btn);
    }
  }

  function pick(x) {
    if (locked) return;
    locked = true;

    sfxUnlock(); // 念のため
    if (x === ans) {
      ok++;
      elOk.textContent = ok;
      elMsg.textContent = "⭕ せいかい！";
      sfxCorrect();
      if (navigator.vibrate) navigator.vibrate(30);
    } else {
      ng++;
      elNg.textContent = ng;
      elMsg.textContent = `❌ ちがうで！ こたえは ${ans}`;
      sfxWrong();
      if (navigator.vibrate) navigator.vibrate([40, 40, 40]);
    }

    // 次へ（少し待ってから）
    setTimeout(() => {
      cur++;
      if (cur > 10) {
        end();
      } else {
        newQuestion();
      }
    }, 900);
  }

  function end() {
    locked = false;
    elChoices.innerHTML = "";
    elQ.textContent = "おしまい！";
    elMsg.textContent = `スコア：正解 ${ok} / 10`;

    const btn = document.createElement("button");
    btn.textContent = "もう1回やる";

    btn.addEventListener("pointerdown", () => {
      sfxUnlock();
      sfxClick();
    });

    btn.onclick = () => {
      cur = 1; ok = 0; ng = 0;
      elOk.textContent = 0;
      elNg.textContent = 0;
      newQuestion();
    };

    elChoices.appendChild(btn);
  }

  newQuestion();
</script>
</body>
</html>
